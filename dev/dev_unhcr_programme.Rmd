---
title: "IATI Visualisation"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r developmenttest, include=FALSE, message=FALSE, warning=FALSE}
library(testthat) 
# Load already included functions
pkgload::load_all(export_all = FALSE)
```



```{r development_with_mixral, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
## This chart library was conveniently built using an offline LLM - 
###########
# pak::pak("JBGruber/rollama")
library(rollama)
options(rollama_server = "http://localhost:11434")
options("rollama_verbose" = TRUE)
## Using the last mixtral instruct with good quantization from TheBloke
## https://mistral.ai/news/mixtral-of-experts/ 
# pull_model("mixtral:8x7b-instruct-v0.1-q4_K_M")
options(rollama_model = "mixtral:8x7b-instruct-v0.1-q4_K_M")
options(rollama_config = "<s> [INST]Act if you were an R developer. 
You are writing functions that will be included within an R package called “iati”.[/INST]

The data themselves are already part of the package, stored a .RData files.

Each function should include documentation using `roxygen2`.

Insert line breaks into the `roxygen2` documentation after every 80 characters.

The documentaiton should include description of the function parameters, the imported libraries and provide an example for the function. 

In the answer to the prompt, include the function within an R markdonw Rmd chunk.  
 
As much as possible, include at first functions from within the tidyverse package universe. 

Always opt for a simple coding style that is accessible to everyone. Avoid complex approach, no need to show that you are smarter than me!

Add comments within the code to explain what is happening: All explanations should exclusively be kept as comments within the function itself.


Typically, the function will include first some data tidy stage and then the visualization using ggplot2. 

When generating a ggplot2 chart, use UNHCR theme from unhcrthemes package using the following:
 `unhcrthemes::theme_unhcr(grid = TRUE, axis = \"Y\", axis_title = \"X\") + ` 

When using a color scale, please use the following: 
` ggplot2::scale_fill_viridis_d(option = \"inferno\", na.value = \"grey50\") + ` 

When one axis includes continuous values please use:
`ggplot2::scale_y_continuous( expand = ggplot2::expansion(mult = c(0, .1)), labels = scales::label_number(scale_cut = scales::cut_short_scale())) +`

Add a specific caption in each charts with the following:
`labs(caption = \"Data Source: UNHCR IATI (International Aid Transparency Initiative)\") + ``
</s>
 [INST]
At the end include some unit testing for the created function.[/INST]  
 ")
ping_ollama()

# 
# my_ai_function <- rollama::query("Write a function that will take 3 parameters:  
# 
#  1. TransactionType – a parameter that can take value such as \"Incoming Commitment\"  
# 
#  2. year – corresponding the first year of focus until the most recent year within the dataset  
# 
#  3. region or countries 
# 
# The output of the function should be a plot showing transaction for a specific country from a certain year. ")
# 
# dput(my_ai_function$message$content )

``` 
 
 
# Using  `iati::dataTransaction`

## Show donors 
 
 *  Who are the __main donors by country__ in terms of number of     projects and/or total budget?   

```{r function-show_donors, echo=FALSE, message=FALSE, warning=FALSE}
#' show_donors
#'
#' @description Who are the main donors by country in terms of number of projects and/or total budget? 
#' 
#' @param year year to select starting from 2016 - could be one year or a list
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param transaction_type_name Transaction type - default is "Incoming Commitment" ,
#'   can also be   "Disbursement", or "Expenditure"  
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
show_donors <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL,
                        transaction_type_name = "Incoming Commitment"  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year >= thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year >= thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year >= thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  }
   
  df <- df |> 
    dplyr::group_by(year, reporting_org_type_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(reporting_org_type_name = as.character(reporting_org_type_name) )  |>
    dplyr::mutate(reporting_org_type_name = as.factor(reporting_org_type_name) ) 
  
 p <- df |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = reporting_org_type_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X")+
  ggplot2::labs(
    title = paste0(transaction_type_name," received by UNHCR in USD"),
    subtitle = paste0("In ", programme_lab, ctr_name,iati_identifier_ops, " recorded since ", year,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)" ) 
 
  return(p)
}
```


```{r examples-show_donors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}

knitr::kable( codeTransactionType |> dplyr::select(name,  description) )

show_donors(year = 2018,
           programme_lab = "The Americas",
           transaction_type_name = "Incoming Commitment" )

show_donors(year = 2018,
           ctr_name = "Brazil",
           transaction_type_name = "Incoming Commitment" )


show_donors(year = 2018,
           programme_lab = "The Americas",
           transaction_type_name = "Disbursement" )


show_donors(year = 2018,
           programme_lab = "The Americas",
           transaction_type_name = "Expenditure" )

```

```{r tests-show_donors}
test_that("show_donors works", {
  expect_true(inherits(show_donors, "function")) 
})
```

## show_earmarking

 *  What’s the breakdown of __Earmarking Type__ (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
 
    
```{r function-show_earmarking}
#' Title
#' 
#' @description What’s the breakdown of Earmarking Type (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
#' 
#' @param year A numeric value corresponding to the first year of focus until the most recent year within the dataset.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_earmarking <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  }
   
  df <- df |> 
    dplyr::group_by(year, aid_type1_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(aid_type1_name = as.character(aid_type1_name) )  |>
    dplyr::mutate(aid_type1_name = as.factor(aid_type1_name) ) 
  
 p <- df |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = aid_type1_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X")+
  ggplot2::labs(
    title = paste0("Earmarking level in USD"),
    subtitle = paste0("In  recorded since ", year,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)" ) 
 
  return(p) 
}
```
  
```{r example-show_earmarking, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_earmarking(year = 2018, 
             programme_lab = NULL, 
             iati_identifier_ops = NULL, 
             ctr_name = "Brazil")
```
  
```{r tests-show_earmarking}
test_that("show_earmarking works", {
  expect_true(inherits(show_earmarking, "function")) 
})
```
  



# Using `iati::dataBudget`

## show_expenditure

 *  How much __expenditures compare to the initial budget__ (weighted by # PoCs / GPP in the country)?   
    
```{r function-show_expenditure}
#' Title
#' 
#' How much expenditures compare to the initial budget (weighted by # PoCs / GPP in the country)?   

#' @param year A numeric value corresponding to the first year of focus until the most recent year within the dataset.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_expenditure <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   |> 
         dplyr::left_join(iati::dataBudget, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year >= thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  }
   
  df <- df |> 
    dplyr::group_by(year, aid_type1_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(aid_type1_name = as.character(aid_type1_name) )  |>
    dplyr::mutate(aid_type1_name = as.factor(aid_type1_name) ) 
  
 p <- df |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = aid_type1_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X")+
  ggplot2::labs(
    title = paste0("Earmarking level in USD"),
    subtitle = paste0("In  recorded since ", year,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)" ) 
 
  return(p)
}
```
  
```{r example-show_expenditure, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_expenditure(year = 2018, 
             programme_lab = NULL, 
             iati_identifier_ops = NULL, 
             ctr_name = "Brazil")
```
  
```{r tests-show_expenditure}
test_that("show_expenditure works", {
  expect_true(inherits(show_expenditure, "function")) 
})
```


# Using `iati::dataParticipating_org`

## Show partnership

 
 *  What’s the level of __partnership between organisations__ when implementing projects?   
 

```{r function-show_partnership, echo=FALSE, message=FALSE, warning=FALSE}
#' show_partnership
#' 
#' @description What’s the level of partnership between organisations when implementing projects? 
#'
#' @param year A numeric value corresponding to the year to be displayed
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_partnership <- function( year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataParticipating_org |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year == thisyear )
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year == thisyear )
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year == thisyear )
  }
  
  df2 <- df    |>
    dplyr::select(participating_org_eng, 
                  participating_org_type_name, 
                  participating_org_role_name) |>
     tidyr::pivot_wider(names_from = participating_org_role_name, 
              values_from = participating_org_eng )
  
  df3 <- df    |>
    dplyr::select(participating_org_eng, 
                  participating_org_type_name, 
                  participating_org_role_name) |>
    #  count(across(everything())) |>
     tidyr::pivot_wider(names_from = participating_org_role_name, 
               values_from = participating_org_eng,
                values_fn = function(x) length(!is.na(x)),
                values_fill = 0)
  
  ##df |> dplyr::select(participating_org_type, participating_org_role ) |> dplyr::distinct()
   
  ## Let's build a table with a participating type as row - role as column -
  # and in the cell the numeber and list of corresponding org.. participating_org_eng
  ## Facet this by year... 
  
  # Dummy data
    # participating_org_type_name <- LETTERS[1:8]
    # participating_org_type_role <- paste0("var", seq(1,4))
    # df <- expand.grid(participating_org_type_name = participating_org_type_name,
    #                   participating_org_type_role = participating_org_type_role)
    # df$count <- runif(32, 0, 5)
  
  
#  p <- df3 |> 
# #  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
#   ggplot2::ggplot(ggplot2::aes(x =  participating_org_type_name, 
#                                y = participating_org_type_role , 
#                                fill = count,
#                                label = count)) +
#     
#   ggplot2::geom_tile(alpha = 0.9) +  
#   ggplot2::geom_text( size=2.5)  + 
#   #ggplot2::scale_fill_viridis_c(option = "inferno", na.value = "grey50" ) +
#   ggplot2::scale_fill_gradient2(low = "white" ,
#                        mid = "#FFFFCC",
#                        high = "#075AFF") 
#   unhcrthemes::theme_unhcr(grid =  FALSE, axis = FALSE, axis_title =  TRUE, legend = FALSE)+
#   ggplot2::labs(
#     title = paste0(" Partners"),
#     subtitle = paste0("In ", programme_lab, " recorded since ", year,""),
#     x = "Organisation Type",
#     y = "Organisation Role",
#     caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)" ) 
 
  p <- knitr::kable( df2  )
  
  return(p)
}
```
 
```{r examples-show_partnership, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_partnership(year = 2022,
           ctr_name = "Brazil" ) 
```

```{r tests-show_partnership}
test_that("show_partnership works", {
  expect_true(inherits(show_partnership, "function")) 
})
```


# Using `iati::dataSector`

## show_sectors

 *  What are the __most funded sectors__ per country (Expenditure evolution per impact /outcome area)?  
    
```{r function-show_sectors}
#' show_sectors
#' 
#' @description  What are the most funded sectors per country (Expenditure evolution per impact /outcome area)?  
#' 
#' @param year A numeric value corresponding to the first year of focus until the most recent year within the dataset.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param sector_vocabulary_name sector_vocabulary
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' @return  a graph
show_sectors <- function(year, 
                         programme_lab = NULL, 
                         iati_identifier_ops = NULL, 
                         ctr_name = NULL,
                         sector_vocabulary_name = "Reporting Organisation 2"){
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  # Join dataActivity and dataSector on iati_identifier 
  df <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity,  by = c("iati_identifier"))
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <- year
    thissector_vocabulary <- sector_vocabulary
    df <- df |> 
      dplyr::filter(programmme_lab == thiprogramme_lab &
            year > thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <- year
    thissector_vocabulary_name <- sector_vocabulary_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year > thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <- year
    thissector_vocabulary_name <- sector_vocabulary_name
    df <- df |> 
      dplyr::filter(ctr_name == thisctr_name &
            year > thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  }
  
  df <- df |> 
    dplyr::group_by(sector_desc, year) |> 
    dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
   # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
  #  top_n(5, wt = sector_pct) |> 
    dplyr::mutate(sector_desc = as.factor(sector_desc))
  

  p <-  ggplot2::ggplot(data = df, 
                        ggplot2::aes(x = reorder(sector_desc, sector_pct),
                                 y = sector_pct
                                 )) +
    unhcrthemes::theme_unhcr(grid = TRUE, axis = "Y", axis_title = "Sector Percentage") +
    ggplot2::geom_bar(stat = "identity") +
    ggplot2::coord_flip()+
    ggplot2::facet_wrap( ggplot2::vars(year)) +
    ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, .1)), labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    ggplot2::labs(title = "Share of budget per sectors for the selected year", 
         x = "Sectors", y = "% of Total Funding", 
         caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)") 

    
 
  return(p)
}
```
  
```{r example-show_sectors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}

knitr::kable( iati::dataSector |> 
                dplyr::select( sector_vocabulary_name, sector_vocabulary_description) |>
                dplyr::distinct())

show_sectors(year = 2018, 
             programme_lab = NULL, 
             iati_identifier_ops = NULL, 
             ctr_name = "Syria",
            sector_vocabulary_name = "Reporting Organisation 2")
```
  
```{r tests-show_sectors}
test_that("show_sectors works", {
  expect_true(inherits(show_sectors, "function")) 
})
```
   
 
# Using `iati::dataResult`

## show_indicators
    
 *  How much __indicators__ evolve over time against thresholds?
 
```{r function-show_indicators}
#' show_indicators
#' 
#' How much indicators evolve over time against thresholds?
#' 
#' @param year A numeric value corresponding to the first year of focus until the most recent year within the dataset.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param  result_type_name either  "Impact"  "Outcome" "Output" - default is  "Outcome"  
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' 
#' @return  a graph
show_indicators <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                       result_type_name = "Outcome") {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataResult |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      # levels(as.factor(df$result_type_name ))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year >= thisyear & 
             result_type_name ==  thisresult_type_name)
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year >= thisyear & 
             result_type_name ==  thisresult_type_name)
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year >= thisyear & 
            result_type_name ==  thisresult_type_name)
  }
   
  ## in order to compare indictors alltogether in the same country, we need to normalise them
  ## one way is to compute the distance to the target...
  ## names(df)
  df1 <- df  |> 
    dplyr::select(result_type_name ,  result_title, indicator_measure_name, result_indicator_title,
                  result_indicator_baseline_value, result_indicator_target_value,
                  result_indicator_baseline_location_ref, result_indicator_baseline_dimension_1,
                  result_indicator_baseline_dimension_value_1, result_indicator_baseline_dimension_2,
                  result_indicator_baseline_dimension_value_2) |>
      dplyr::mutate(  actual = as.numeric(result_indicator_baseline_value),
                      target = as.numeric(result_indicator_target_value),
                      
              ## Calculating gap to target        
                      gap_actual_target = - round( (  target - actual) /  target *100  ,2 ),
                      #gap_actual_target = dplyr::if_else(reverse == "TRUE", gap_actual_target * -1, gap_actual_target), 
                      gap_actual_target =   gap_actual_target , 
                      gap_color = dplyr::case_when(
                        gap_actual_target >= 0     ~ "green",
                        gap_actual_target < 0  & gap_actual_target >= -10    ~ "orange",
                        gap_actual_target < -10     ~ "red",  
                                                   TRUE ~ "") )     |> 
    dplyr::filter (! (is.na(actual)))  |> 
    dplyr::filter (! (is.nan(gap_actual_target))) |>
      #dplyr::arrange(desc(actual))
      dplyr::group_by( result_indicator_title) |>
      dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
      dplyr::ungroup(result_indicator_title) |>
              
              
              ## Calculating gap to green threshold
              #dplyr::mutate(  gap_actual_green = - round( ( threshold_green - actual) /  threshold_green *100 ,2 ),
                      # gap_actual_green = dplyr::if_else(reverse == "TRUE", gap_actual_green * -1, gap_actual_green), 
                      # gap_color_green = dplyr::case_when(
                      #   gap_actual_green >= 5     ~ "green",
                      #   gap_actual_green < 5  & gap_actual_target >= -15    ~ "orange",
                      #   gap_actual_green < -15     ~ "red",  
                      #                              TRUE ~ "")  )     |> 

  ## Reshape the inidcator label... 
      dplyr::mutate( operation = as.character(glue::glue("{result_title}-
                                                         {result_indicator_title} /
                                                         {result_indicator_baseline_dimension_1}") ) )  
 
  ## case there's no data at all
  if( nrow(df1) == 0) {
        info <-  paste0("No gap analysis could be \n produced for \n outcome indicator values \n in ", 
                      programme_lab, ctr_name,iati_identifier_ops)
        p <- ggplot2::ggplot() +  
             ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                  label = info ) +  
             ggplot2::theme_void()
  
   } else if(nrow(df1)> 0) {
  
      ## and now the plot
      p <-      ggplot2::ggplot(  data = df1) +
        ggplot2::coord_flip()  + 
        # geom_col(   aes(x = reorder(operation, - gap_actual_green), 
        #                 y = gap_actual_green ,
        #                 fill = gap_color_green ),
        #            # fill = "grey50",    
        #             alpha = 0.3,    
        #             width = 0.9,
        #            color = NA ) +
        ggplot2::geom_col(   
          ggplot2::aes(x = reorder(operation, - gap_actual_target),
                       y = gap_actual_target,
                       fill = gap_color ),
                    #fill = "#0072BC",
                    width = 0.7,
                    color = NA ) +
        ggplot2::scale_fill_manual(values = c( "red" = "#D3212C",   
                                      "orange" = "#FF980E",
                                      "green" = "#069C56")) +
        ggplot2::geom_text( 
          ggplot2::aes(x = reorder(operation, - gap_actual_target), 
                       y = gap_actual_target,
                       label = paste(round(gap_actual_target, 1), " %") ),
                   #hjust = 1.5, 
                   size = 2.5,
                   color = "black")  +
        # scale_y_continuous( label = scales::label_percent(accuracy = 0,
        #                                    suffix = "%") ) +
        ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                          scale_cut = scales::cut_short_scale(),
                                                          suffix = "%") )+
        ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
        unhcrthemes::theme_unhcr(font_size = 18, 
                                 axis_text_size = 9,
                                 grid = "X", 
                                 axis = "y") +
        ggplot2::theme(  #axis.text.y = ggtext::element_markdown(),
                legend.position = "none")+
        ggplot2::labs( x = "", y = "" ,
              title = stringr::str_wrap( 
                paste0("Outcome Indicators (RBM) | ", thisyear, " ", 
                        programme_lab, ctr_name,iati_identifier_ops ) ,
                100),
              subtitle = stringr::str_wrap( paste0( 
                "Gap in % between \"Actual\" reported value and the \"acceptable\" standard threshold" ) ,
                110),
              caption = stringr::str_wrap( "Data Source: UNHCR IATI (International Aid Transparency Initiative)" ,
              110) )  
      }
 
  return(p)
    
}
```
  
```{r example-show_indicators, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_indicators(year = 2022, 
             programme_lab = NULL, 
             iati_identifier_ops = NULL, 
             ctr_name = "Brazil",
              result_type_name = "Outcome"
             )
```
  
```{r tests-show_indicators}
test_that("show_indicators works", {
  expect_true(inherits(show_indicators, "function")) 
})
```
  




```{r development-inflate, eval=FALSE}
# Inflate the package

# You're one inflate from paper to box.
# Build your package from this very Rmd using `fusen::inflate()`
# 
# - Verify your `"DESCRIPTION"` file has been updated
# - Verify your function is in `"R/"` directory
# - Verify your test is in `"tests/testthat/"` directory
# - Verify this Rmd appears in `"vignettes/"` directory

# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_unhcr_programme.Rmd", vignette_name = "UNHCR Programme")
```



