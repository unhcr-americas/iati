---
title: "IATI Visualisation"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r developmenttest, include=FALSE, message=FALSE, warning=FALSE}
library(testthat) 
# Load already included functions
pkgload::load_all(export_all = FALSE)
```



```{r development_with_mixral, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
## This chart library was conveniently built using an offline LLM - 
###########
# pak::pak("JBGruber/rollama")
library(rollama)
options(rollama_server = "http://localhost:11434")
options("rollama_verbose" = TRUE)
## Using the last mixtral instruct with good quantization from TheBloke
## https://mistral.ai/news/mixtral-of-experts/ 
# pull_model("mixtral:8x7b-instruct-v0.1-q4_K_M")
options(rollama_model = "mixtral:8x7b-instruct-v0.1-q4_K_M")
options(rollama_config = "<s> [INST]Act if you were an R developer. 
You are writing functions that will be included within an R package called “iati”.[/INST]

The data themselves are already part of the package, stored a .RData files.

Each function should include documentation using `roxygen2`.

Insert line breaks into the `roxygen2` documentation after every 80 characters.

The documentaiton should include description of the function parameters, the imported libraries and provide an example for the function. 

In the answer to the prompt, include the function within an R markdonw Rmd chunk.  
 
As much as possible, include at first functions from within the tidyverse package universe. 

Always opt for a simple coding style that is accessible to everyone. Avoid complex approach, no need to show that you are smarter than me!

Add comments within the code to explain what is happening: All explanations should exclusively be kept as comments within the function itself.


Typically, the function will include first some data tidy stage and then the visualization using ggplot2. 

When generating a ggplot2 chart, use UNHCR theme from unhcrthemes package using the following:
 `unhcrthemes::theme_unhcr(grid = TRUE, axis = \"Y\", axis_title = \"X\") + ` 

When using a color scale, please use the following: 
` ggplot2::scale_fill_viridis_d(option = \"inferno\", na.value = \"grey50\") + ` 

When one axis includes continuous values please use:
`ggplot2::scale_y_continuous( expand = ggplot2::expansion(mult = c(0, .1)), labels = scales::label_number(scale_cut = scales::cut_short_scale())) +`

Add a specific caption in each charts with the following:
`labs(caption = \"Data Source: UNHCR IATI (International Aid Transparency Initiative)\") + ``
</s>
 [INST]
At the end include some unit testing for the created function.[/INST]  
 ")
ping_ollama()

# 
# my_ai_function <- rollama::query("Write a function that will take 3 parameters:  
# 
#  1. TransactionType – a parameter that can take value such as \"Incoming Commitment\"  
# 
#  2. year – corresponding the first year of focus until the most recent year within the dataset  
# 
#  3. region or countries 
# 
# The output of the function should be a plot showing transaction for a specific country from a certain year. ")
# 
# dput(my_ai_function$message$content )

``` 
 



# Show donors 
 
 *  Who are the __main donors by country__ in terms of number of     projects and/or total budget?   
 

```{r function-show_donors, echo=FALSE, message=FALSE, warning=FALSE}
#' Ploting Donors
#'
#' 
#' @param thisyear year to select starting from 2016 - could be one year or a list
#' @param thisprogrammme_lab  programme_lab
#' @param thistransaction_type_name Transaction type
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
show_donors <- function(thisyear, 
                        thisprogrammme_lab,
                        thistransaction_type_name = "Incoming Commitment"  ) {
  #require(ggplot2)
 # require(tidyverse)
#  require(scales)
Transaction0 <- iati::dataTransaction |> 
  dplyr::left_join(iati::dataActivity, by= c("iati_identifier")) 

Transaction <- Transaction0 |> 
  ## Add filters 
  dplyr::filter(year >= as.integer(thisyear)) |> 
  #dplyr::filter(year >= 2018) |>    
  dplyr::filter(programmme_lab == as.character(thisprogrammme_lab)) |> 
  ## Add filters transaction type  transaction type 
 #  dplyr::filter(TransactionType == "Incoming Commitment") |>  
  dplyr::filter(transaction_type_name %in% thistransaction_type_name) |>  
 
  dplyr::group_by(year, reporting_org_type_name) |>
  dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
  dplyr::mutate(reporting_org_type_name = as.character(reporting_org_type_name) )  |>
  dplyr::mutate(reporting_org_type_name = as.factor(reporting_org_type_name) ) 

p <- Transaction |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = reporting_org_type_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())
  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr()+
  ggplot2::labs(
    title = paste0(thistransaction_type_name," received by UNHCR in USD"),
    subtitle = paste0("In ",  thisprogrammme_lab, " recorded since ", thisyear,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)"
  ) 
 
  return(p)
}
```


```{r examples-show_donors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}

knitr::kable( codeTransactionType |> dplyr::select(name,  description) )

show_donors(thisyear = 2018,
           thisprogrammme_lab = "The Americas",
           thistransaction_type_name = "Incoming Commitment" )


show_donors(thisyear = 2018,
           thisprogrammme_lab = "The Americas",
           thistransaction_type_name = "Disbursement" )

```

```{r tests-show_donors}
test_that("show_donors works", {
  expect_true(inherits(show_donors, "function")) 
})
```


# Show implementers 

 
 *  Who are the __main implementing partners by country__ in terms of number of projects and/or total budget?  
 

```{r function-show_implementers, echo=FALSE, message=FALSE, warning=FALSE}
#' Ploting implementer
#'
#' 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_implementers <- function(  ) {
 
}
```
 
```{r examples-show_implementers, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_implementers( ) 
```

```{r tests-show_implementers}
test_that("show_implementers works", {
  expect_true(inherits(show_implementers, "function")) 
})
```



# show_sectors

 *  What are the __most funded sectors__ per country (Expenditure evolution per impact /outcome area)?  
    
```{r function-show_sectors}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_sectors <- function(){
    
}
```
  
```{r example-show_sectors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_sectors()
```
  
```{r tests-show_sectors}
test_that("show_sectors works", {
  expect_true(inherits(show_sectors, "function")) 
})
```
   
 
# show_earmarking

 *  What’s the breakdown of __Earmarking Type__ (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
 
    
```{r function-show_earmarking}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_earmarking <- function(){
    
}
```
  
```{r example-show_earmarking, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_earmarking()
```
  
```{r tests-show_earmarking}
test_that("show_earmarking works", {
  expect_true(inherits(show_earmarking, "function")) 
})
```
  


# show_partnership

 *  What’s the level of __partnership between organisations__ when implementing projects?  
    
```{r function-show_partnership}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_partnership <- function(){
    
}
```
  
```{r example-show_partnership, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_partnership()
```
  
```{r tests-show_partnership}
test_that("show_partnership works", {
  expect_true(inherits(show_partnership, "function")) 
})
```
   
  
# show_expenditure

 *  How much __expenditures compare to the initial budget__ (weighted by # PoCs / GPP in the country)?   
    
```{r function-show_expenditure}
#' Title
#' 
#' Description
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_expenditure <- function(){
    
}
```
  
```{r example-show_expenditure, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_expenditure()
```
  
```{r tests-show_expenditure}
test_that("show_expenditure works", {
  expect_true(inherits(show_expenditure, "function")) 
})
```
  

# show_indicators
    

 *  How much __indicators__ evolve over time against thresholds?
 
```{r function-show_indicators}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_indicators <- function(){
    
}
```
  
```{r example-show_indicators, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_indicators()
```
  
```{r tests-show_indicators}
test_that("show_indicators works", {
  expect_true(inherits(show_indicators, "function")) 
})
```
  




```{r development-inflate, eval=FALSE}
# Inflate the package

# You're one inflate from paper to box.
# Build your package from this very Rmd using `fusen::inflate()`
# 
# - Verify your `"DESCRIPTION"` file has been updated
# - Verify your function is in `"R/"` directory
# - Verify your test is in `"tests/testthat/"` directory
# - Verify this Rmd appears in `"vignettes/"` directory

# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_unhcr_programme.Rmd", vignette_name = "UNHCR Programme")
```



