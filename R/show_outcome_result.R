# WARNING - Generated by {fusen} from dev/dev_unhcr_programme.Rmd: do not edit by hand

#' Title
#' 
#' @param year A numeric value corresponding to the first year of focus until the most recent year within the dataset.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param  outcome any of:
#'   "OA1: Access to Territory, Reg. and Documentation", 
#'   "OA2: Status Determination",
#'   "OA3: Protection Policy and Law", 
#'   "OA4: Sexual and Gender-based Violence",
#'   "OA5: Child Protection",
#'   "OA6: Safety and Access to Justice", 
#'   "OA7: Community Engagement and Women's Empowerment", 
#'   "OA8: Well-Being and Basic Needs", 
#'   "OA9: Sustainable Housing and Settlements", 
#'   "OA10: Healthy Lives" ,
#'   "OA11: Education",  
#'   "OA12: Clean Water, Sanitation and Hygiene",
#'   "OA13: Self Reliance, Economic Inclusion and Livelihoods",
#'   "OA14: Voluntary Repatriation and Sustainable Reintegration",
#'   "OA15: Resettlement and Complementary Pathways", 
#'   "OA16: Local Integration and other Local Solutions"
 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import patchwork
#' @import cowplot
#' @import grid
#' @import purrr
#' @importFrom stats reorder
#'
#' @export 
#' 
#' @return  a graph
#' @examples
#' show_outcome_result(year =  c(  2020, 2021, 2022), 
#'              ctr_name = "Brazil",
#'              outcome = "OA2: Status Determination")
#' show_outcome_result(year =  c(  2020, 2021, 2022), 
#'              ctr_name = "Brazil",
#'              outcome = "OA9: Sustainable Housing and Settlements")
#' show_outcome_result(year =  c(  2020, 2021, 2022), 
#'              ctr_name = "Brazil",
#'              outcome = "OA8: Well-Being and Basic Needs")
#' show_outcome_result(year =  c(  2020, 2021, 2022), 
#'              ctr_name = "Brazil",
#'              outcome = "OA4: Sexual and Gender-based Violence")
show_outcome_result <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                       outcome) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataResult |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   
  
 
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year  
    thisoutcome <-  outcome
    df <- df |> 
      # levels(as.factor(df$result_type_name ))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             result_type_name ==  "Outcome")  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::filter( sector_rbm == thisoutcome) |>
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
    
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    thisoutcome <-  outcome
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             result_type_name ==   "Outcome")  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::filter( sector_rbm == thisoutcome) |>
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
    
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year  
    thisoutcome <-  outcome
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
            result_type_name ==   "Outcome")  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::filter( sector_rbm == thisoutcome) |>
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
  }
   
  ## in order to compare indictors alltogether in the same country, we need to normalise them
  ## one way is to compute the distance to the target...
  ## names(df)
  
  #table(df$result_indicator_ascending, useNA = "ifany")
  df1 <- df  |> 
    dplyr::select(result_type_name ,  result_title, sector_rbm,
                  indicator_measure_name, result_indicator_title,
                  year,
                  
                  result_indicator_baseline_value, 
                  result_indicator_actual_value,
                  result_indicator_target_value,
                  result_indicator_target_value_1,
                  
                  result_indicator_baseline_location_ref, 
                  result_indicator_baseline_dimension_1,
                  result_indicator_baseline_dimension_value_1, 
                  result_indicator_baseline_dimension_2,
                  result_indicator_baseline_dimension_value_2,
                  result_indicator_ascending,  
                  sector_rbm,
                  threshold_red, threshold_orange, threshold_green) |>
     ## Quick fix in case ascending is not documented...
     dplyr::mutate(  result_indicator_ascending = dplyr::if_else( is.na(result_indicator_ascending), 
                                               "1", 
                                               result_indicator_ascending))   |>    
     
      dplyr::mutate(  actual = as.numeric(result_indicator_actual_value),
                      baseline = as.numeric(result_indicator_baseline_value),
                      target = as.numeric(result_indicator_target_value), 
                      ## Reshape the indicator label... 
                      operation = as.character(glue::glue("{result_indicator_title} / {result_indicator_target_value_1}") ), 
                      # operation = as.character(glue::glue("{result_indicator_title} / {result_title} -
                      #                                        {result_indicator_target_value_1}") ),  
                      
                      
              ## Calculating deviation to target        
                      deviation_actual_target =  round( ( actual - target ) / 
                                                           dplyr::if_else(target == 0, 1, target) * 
                                                           dplyr::if_else(target == 0, 1, 100) ,2 ),
               
                      ## Account for indicator direction
                      deviation_actual_target = dplyr::if_else(result_indicator_ascending == 0, 
                                                         deviation_actual_target * -1, 
                                                         deviation_actual_target),   
                      
                      deviation_color = dplyr::case_when(
                        deviation_actual_target >= -1     ~ "green",
                        deviation_actual_target < -1  & deviation_actual_target >= -15    ~ "orange",
                        deviation_actual_target < -15     ~ "red",  
                                                   TRUE ~ ""),
              ## Calculating progress to baseline..        
                      progress_baseline =  round( ( actual - baseline) / 
                                                           dplyr::if_else(baseline == 0, 1, baseline) * 
                                                           dplyr::if_else(baseline == 0, 1, 100)  ,2 ), 
                      ## Account for indicator direction
                      progress_baseline = dplyr::if_else(result_indicator_ascending == 0, 
                                                         progress_baseline * -1, 
                                                         progress_baseline),   
                      progress_color = dplyr::case_when(
                        progress_baseline >= -1     ~ "green",
                        progress_baseline < -1  & progress_baseline >= -15    ~ "orange",
                        progress_baseline < -15     ~ "red",  
                                                   TRUE ~ ""),
              
                      gap_green =  round( ( threshold_green - actual ) / 
                                           dplyr::if_else(threshold_green == 0, 1, threshold_green) * 
                                           dplyr::if_else(threshold_green == 0, 1, 100)  ,2 ),
                      gap_green = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_green * -1, 
                                                         gap_green), 
              
                      gap_orange =  round( ( threshold_orange - actual ) / 
                                           dplyr::if_else(threshold_orange == 0, 1, threshold_orange) * 
                                           dplyr::if_else(threshold_orange == 0, 1, 100)  ,2 ), 
                      gap_orange = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_orange * -1, 
                                                         gap_orange), 
                      
                      gap_red =  round( ( threshold_red - actual ) / 
                                           dplyr::if_else(threshold_red == 0, 1, threshold_red) * 
                                           dplyr::if_else(threshold_red == 0, 1, 100)  ,2 ),
                      gap_red = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_red * -1, 
                                                         gap_red)
              
              )    
  
      ## create a uniform indicator shape palette across charts 
      shape_indicator <- df1 |> 
                          dplyr::select(result_indicator_title)  |>
                          dplyr::distinct() |>
                          dplyr::mutate(n = dplyr::row_number() -1)  |> 
                          dplyr::pull(n) |>
                          purrr::set_names(df1 |> 
                                             dplyr::select(result_indicator_title)  |> 
                                             dplyr::distinct() |>
                                             dplyr::pull(result_indicator_title)) 
       
      # Using the cowplot package
      indiclegendp <- ggplot2::ggplot(df1, aes(x = year,
                          y = deviation_actual_target,
                          shape = result_indicator_title)) +
                 ggplot2::geom_point() +
                 ggplot2::scale_shape_manual(values = shape_indicator,
                              labels = function(x) stringr::str_wrap(x, width = 45),
                              name = "Indicators for that outcome")  +
                unhcrthemes::theme_unhcr() +
                ggplot2::theme( legend.direction = "vertical",
                                legend.box = "vertical",
                              legend.position = "left" ,
                              legend.key.size = unit(1, "cm"))  
      
 
      indiclegend <-  cowplot::ggdraw() +
                          cowplot::draw_grob( grid::grobTree(cowplot::get_legend(indiclegendp)))
  
      ## ## https://www.researchgate.net/publication/334894331_Polychrome_Creating_and_Assessing_Qualitative_Palettes_with_Many_Colors
      #install.packages("Polychrome")
      ## Green-Armytage (2010) alphabet color - initially mapped - then corrected based on color mapping with SDG code
      #GreenArmytage <- Polychrome::green.armytage.colors(16)
      palette_outcome <- c("OA1: Access to Territory, Reg. and Documentation" ="#F0A3FF", 
                           "OA2: Status Determination" = "#C20088",
                           "OA3: Protection Policy and Law" = "#993F00", 
                           "OA4: Sexual and Gender-based Violence" = "#FF3A21", #  "#4C005C",
                           "OA5: Child Protection" =  "#FFCC99",
                           "OA6: Safety and Access to Justice" = "#00689D", # "#003380", 
                           "OA7: Community Engagement and Women's Empowerment"= "#94FFB5", 
                           "OA8: Well-Being and Basic Needs" =   "#e5243b",  # "#005C31", 
                           "OA9: Sustainable Housing and Settlements" = "#FD9D24", #  "#8F7C00", 
                           "OA10: Healthy Lives" = "#4C9F38", #  "#FFA8BB", 
                           "OA11: Education"= "#C5192D", # "#808080",  
                           "OA12: Clean Water, Sanitation and Hygiene"= "#26BDE2", # "#0075DC",
                           "OA13: Self Reliance, Economic Inclusion and Livelihoods" =  "#A21942", #  "#19A405",
                           "OA14: Voluntary Repatriation and Sustainable Reintegration"= "#9DCC00",
                           "OA15: Resettlement and Complementary Pathways" = "#191919", 
                           "OA16: Local Integration and other Local Solutions" =  "#2BCE48")
  
  
 
    
       ## Indicator Deviation  #####
      df2deviation <- df1 |> 
          ## Filter out - when no data...
          dplyr::filter (! (is.na(actual)))  |> 
          dplyr::filter (! (is.na(target)))  |> 
          dplyr::filter (! (is.nan(deviation_actual_target))) |>
          #dplyr::arrange(desc(actual))
          dplyr::group_by( result_indicator_title) |>
          dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
          dplyr::ungroup(result_indicator_title)
     
          ## case there's no data at all
          if( nrow(df2deviation) == 0) {
                info <-  paste0("No deviation - actual to target - \n comparative analysis \n  could be produced for \n",
                                outcome, " indicator values \n in ", 
                              programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
                pdeviation <- ggplot2::ggplot() +  
                     ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                                          label = info ) +  
                     ggplot2::theme_void()
          
           } else if(nrow(df2deviation)> 0) {
              ## and now the plot
              pdeviation <-  ggplot2::ggplot( df2deviation, 
                    ggplot2::aes(x = year,
                          y = deviation_actual_target,
                          shape = result_indicator_title,
                          color = sector_rbm)) + 
                    ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                                  # shape = 17,
                                   size = 3) +
                    guides(shape = "none",
                       color = "none")  + 
                    ggplot2::geom_hline(yintercept= 0, color="red") + 
                    ggplot2::scale_shape_manual(values = shape_indicator) +
                    ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                    ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                         scale_cut = scales::cut_short_scale(),
                                                                         suffix = "%") ) +
                    ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                    unhcrthemes::theme_unhcr(font_size = 14, 
                                             axis_text_size = 9,
                                             grid = "Y", 
                                             axis = "y") +
                    ggplot2::theme( legend.direction = "horizontal",
                                    legend.box = "horizontal",
                                    legend.position = "bottom") +
                    ggplot2::labs( x = "", y = "" ,
                             subtitle = stringr::str_wrap( 
                               paste0( "Indicators Deviation Review "   ) ,
                               100) ,
                             caption = stringr::str_wrap(
                               "between reported \"Actual\" value and programmatic \"Target\" (in %)" ,
                               110) )
           }
 
      
       ## Indicator Progress  #####
      df2progress <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(baseline)))  |> 
        dplyr::filter (! (is.nan(progress_baseline))) |>
        
        ## Remove extreme outliers that are likely data entry issue....
        dplyr::filter(!(abs(progress_baseline - median(progress_baseline)) > 3*sd(progress_baseline))) |>
        
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df2progress) == 0) {
              info <- paste0("No progress - actual to baseline - \n comparative analysis \n  could be produced for \n",
                                  outcome, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
              pprogress <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df2progress)> 0) {
            ## and now the plot
            pprogress <- ggplot2::ggplot( df2progress, 
                 ggplot2::aes(x = year,
                          y = progress_baseline,
                              shape = result_indicator_title,
                              color = sector_rbm)) +
                #color = sector_rbm)) + 
                ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                                     #shape = 17,
                                     size = 3) + 
                guides(shape = "none",
                       color = "none")  +
                 ggplot2::geom_hline(yintercept= 0, color="red") +
                 ggplot2::scale_shape_manual(values = shape_indicator) +
                 ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                 ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                           scale_cut = scales::cut_short_scale(),
                                                                           suffix = "%") )+
                 ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                    unhcrthemes::theme_unhcr(font_size = 14, 
                                             axis_text_size = 9,
                                             grid = "Y", 
                                             axis = "y") +
                    ggplot2::theme( legend.direction = "horizontal",
                                    legend.box = "horizontal",
                                    legend.position = "bottom") +
                
                ggplot2::labs( x = "", y = "" ,
                               subtitle = stringr::str_wrap( 
                                 paste0( "Indicators Progress Comparison " ) ,
                                 100) ,
                               caption = stringr::str_wrap(
                                 " between \"Actual\" reported value and their \"baseline\" (in %)" ,
                                 110) )
             }
 
      
       ## Indicator Gap  #####
       df2gap <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(gap_green)))  |> 
        dplyr::filter (! (is.nan(gap_green))) |>
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df2gap) == 0) {
              info <- paste0("No gap analysis - actual to green threshold - \n comparative analysis \n  could be produced for \n",
                                outcome, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
              pgap <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df2gap)> 0) {
            ## and now the plot
            pgap <-  ggplot2::ggplot( df2gap, 
                  ggplot2::aes(x = year,
                          y = gap_green,
                              shape = result_indicator_title,
                              color = sector_rbm)) +
                  #color = sector_rbm)) + 
                  ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                                       #shape = 17,
                                       size = 3) + 
                  guides(shape = "none",
                         color = "none")  +
                 ggplot2::geom_hline(yintercept= 0, color="red") +
                 ggplot2::scale_shape_manual(values = shape_indicator) +
                 ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                 ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                           scale_cut = scales::cut_short_scale(),
                                                                           suffix = "%") )+
                 ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                 unhcrthemes::theme_unhcr(font_size = 14, 
                                             axis_text_size = 9,
                                             grid = "Y", 
                                             axis = "y") +
                 ggplot2::theme( legend.direction = "horizontal",
                                    legend.box = "horizontal",
                                    legend.position = "bottom") +
                 ggplot2::labs( x = "", y = "" ,
                               subtitle = stringr::str_wrap( 
                                 paste0( "Indicators Gap Analysis"  ) ,
                                 100) ,
                               caption = stringr::str_wrap(
                                 " between \"Actual\" reported value and  \"Acceptable\" global standard for \"green\"  threshold  (in %)" ,
                                 110) )
             }

       ## and now the  ressource allocation  #####
        dfRes <- iati::dataSector |>
          dplyr::left_join(iati::dataActivity,  by = c("iati_identifier"))
        
        if (!is.null(programme_lab)) {
          thisprogramme_lab <- programme_lab
          thisyear <- year 
          dfRes <- dfRes |> 
            dplyr::mutate(year = factor(year)) |>
            dplyr::filter(programmme_lab == thiprogramme_lab &
                  year %in% thisyear & 
                  sector_vocabulary_name ==  "Reporting Organisation 2") |>
            dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
        } else if (!is.null(iati_identifier_ops)) {
          thisiati_identifier_ops <- iati_identifier_ops
          thisyear <- year 
          dfRes <- dfRes |> 
            dplyr::mutate(year = factor(year)) |>
            dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
                  year %in%  thisyear & 
                  sector_vocabulary_name ==  "Reporting Organisation 2") |>
            dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
        } else if (!is.null(ctr_name)) {
          thisctr_name <- ctr_name
          thisyear <- year 
          dfRes <- dfRes |> 
            dplyr::mutate(year = factor(year)) |>
            dplyr::filter(ctr_name == thisctr_name &
                  year %in% thisyear & 
                  sector_vocabulary_name == "Reporting Organisation 2") |>
            dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
        }
        
        dfRes <- dfRes |> 
          dplyr::group_by(sector_desc, sector_rbm, year) |> 
          dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
          dplyr::group_by( sector_rbm, year) |> 
          dplyr::summarise(sector_pct = sum(sector_pct, rm.na = TRUE))  |> 
         # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
        #  top_n(5, wt = sector_pct) |> 
          dplyr::mutate(sector_rbm = as.factor(sector_rbm)) |>
          dplyr::filter( sector_rbm == thisoutcome)
          
        
        
        ## Now joining budget & Expenditure to make the chart more informative...
         df_bud <-  iati::dataTransaction |> 
               dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
        
        if (!is.null(programme_lab)) {
          thisprogramme_lab <- programme_lab
          thisyear <-  year 
         df_bud <- df_bud |> 
            # levels(as.factor(df$programmme_lab))
            dplyr::filter( programmme_lab == thisprogramme_lab &
                  year  %in% thisyear & 
                   transaction_type_name ==  "Expenditure")
        } else if (!is.null(iati_identifier_ops)) {
          thisiati_identifier_ops <- iati_identifier_ops
          thisyear <-  year 
         df_bud <- df_bud |> 
            dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
                  year  %in% thisyear & 
                   transaction_type_name ==  "Expenditure")
        } else if (!is.null(ctr_name)) {
          thisctr_name <- ctr_name
          thisyear <-  year 
          df_bud <- df_bud |> 
            dplyr::filter( ctr_name == thisctr_name &
                  year    %in% thisyear & 
                   transaction_type_name ==  "Expenditure")
        }
        
         df_bud2 <-  df_bud  |> 
              dplyr::group_by(iati_identifier, year) |>
              dplyr::summarise(transaction_value= sum(transaction_value, na.rm = TRUE)) |>
              dplyr::left_join(iati::dataBudget |> 
                                dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                                dplyr::group_by(iati_identifier) |>
                                dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))  
                                  , by= c("iati_identifier"))  |>
           dplyr::select(iati_identifier, year,budget_value,   transaction_value )
         
         dfRes2 <- dfRes |>
               dplyr::left_join(df_bud2, by = c("year") ) |>
               dplyr::mutate( transaction_value2 = transaction_value * sector_pct / 100 ) |>
               dplyr::mutate( transaction_value3 = scales::label_number(accuracy = .2, 
                        ## Bug work around - https://github.com/r-lib/scales/issues/413
                                 scale_cut = append(scales::cut_short_scale(), 1, 1)
                                                                        )(transaction_value2) ) |>
               dplyr::mutate( year2 = glue::glue('{transaction_value3}$'))
           ## https://github.com/r-lib/scales/issues/413#issuecomment-1837583921
  #To install a specific version of a package, we need to install a package called “remotes” and then load it from the library.
  #Afterwards we can use install_version() by specifying the package name and version needed as shown below.
  
  # remove.packages("scales")
  # install.packages("remotes")
  # library(remotes)
  #remotes::install_version("scales", "1.2.1")
      
        presource <-  ggplot2::ggplot(data = dfRes2, 
                              ggplot2::aes(x = year,
                                       y = sector_pct,
                                       fill = sector_rbm,
                                        label = year2
                                       )) +
          
          ggplot2::geom_bar(stat = "identity") + # , fill = "#0072BC"
          ggplot2::geom_text( vjust = -0.5, size = 4)+
          ggplot2::scale_fill_manual(values = palette_outcome,
                            drop = TRUE,
                            limits = force,
                            na.value = "grey50") +
          ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, .1)),
                                      labels = scales::label_number(scale_cut = scales::cut_short_scale())) + 
          
          ggplot2::guides(fill = "none")  +
          unhcrthemes::theme_unhcr(grid = "Y", axis = "y", 
                                   axis_title = "Y",
                                   legend = FALSE,
                                   font_size = 14) +
          ggplot2::labs(subtitle = paste0("Resource Allocation as % of total expenditure"),          
               x = "", y = "% "             ) 
        
        ## now assembling everything 
        # p <- patchwork::wrap_plots(  presource, pgap, pprogress, pdeviation, ncol = 1)
       
       # Match plots to areas by name
        design <- "AAAALL
                   BBCCDD"
        p <- patchwork::wrap_plots(A = presource, 
                                B = pgap, 
                                C = pprogress, 
                                D = pdeviation, 
                                L = indiclegend,
                            
                                design = design) + 
          patchwork::plot_annotation(
            title = paste0("Resource & Results for ",outcome, " in ", programme_lab, ctr_name,iati_identifier_ops),
            caption = 'Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI).'  ) #& 
  #unhcrthemes::theme_unhcr(font_size = 18)
        
  
  return(p)
    
} 
