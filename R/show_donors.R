# WARNING - Generated by {fusen} from dev/dev_unhcr_programme.Rmd: do not edit by hand

#' Ploting Donors
#'
#' 
#' @param thisyear year to select starting from 2016 - could be one year or a list
#' @param thisprogrammme_lab  programme_lab
#' @param thistransaction_type_name Transaction type
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
#' @examples
#'
#' knitr::kable( codeTransactionType |> dplyr::select(name,  description) )
#'
#' show_donors(thisyear = 2018,
#'            thisprogrammme_lab = "The Americas",
#'            thistransaction_type_name = "Incoming Commitment" )
#'
#'
#' show_donors(thisyear = 2018,
#'            thisprogrammme_lab = "The Americas",
#'            thistransaction_type_name = "Disbursement" )
#'
show_donors <- function(thisyear, 
                        thisprogrammme_lab,
                        thistransaction_type_name = "Incoming Commitment"  ) {
  #require(ggplot2)
 # require(tidyverse)
#  require(scales)
Transaction0 <- iati::dataTransaction |> 
  dplyr::left_join(iati::dataActivity, by= c("iati_identifier")) 

Transaction <- Transaction0 |> 
  ## Add filters 
  dplyr::filter(year >= as.integer(thisyear)) |> 
  #dplyr::filter(year >= 2018) |>    
  dplyr::filter(programmme_lab == as.character(thisprogrammme_lab)) |> 
  ## Add filters transaction type  transaction type 
 #  dplyr::filter(TransactionType == "Incoming Commitment") |>  
  dplyr::filter(transaction_type_name %in% thistransaction_type_name) |>  
 
  dplyr::group_by(year, reporting_org_type_name) |>
  dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
  dplyr::mutate(reporting_org_type_name = as.character(reporting_org_type_name) )  |>
  dplyr::mutate(reporting_org_type_name = as.factor(reporting_org_type_name) ) 

p <- Transaction |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = reporting_org_type_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())
  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr()+
  ggplot2::labs(
    title = paste0(thistransaction_type_name," received by UNHCR in USD"),
    subtitle = paste0("In ",  thisprogrammme_lab, " recorded since ", thisyear,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)"
  ) 
 
  return(p)
}
