---
title: "IATI Visualisation"
output: html_document
editor_options: 
  chunk_output_type: console
---

<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->

```{r development, include=FALSE}
library(testthat)
```


```{r developmenttest, include=FALSE, message=FALSE, warning=FALSE}
library(testthat)
# Load already included functions
pkgload::load_all(export_all = FALSE)
```

 
 

<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.

If it is the first time you use {fusen}, after 'description', you can directly run the last chunk of the present file with inflate() inside.
--> 


# Show donors 
 
 *  Who are the __main donors by country__ in terms of number of     projects and/or total budget?   
 

```{r function-show_donors, echo=FALSE, message=FALSE, warning=FALSE}
#' Ploting Donors
#'
#' 
#' @param year year to select starting from 2016 - could be one year or a list
#' @param iati_identifier_ctr_region UNHCR Region  
#' @param TransactionType Transaction type
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
show_donors <- function(year, 
                        iati_identifier_ctr_region,
                        TransactionType = "Incoming Commitment"  ) {
  #require(ggplot2)
 # require(tidyverse)
#  require(scales)
Transaction0 <- iati::dataTransaction |> 
  
  ## let's decompose IATI identifiers to define specific programme
  
  # XM-DAC-41121-2023-WCA-TCD
  # XM-DAC-41121 --> UNHCR
  #  2023 --> year
  # WCA --> Region
  # TCD --> Country
  dplyr::mutate( 
    iati_identifier_year_reg_ops = stringr::str_remove(
                          string = iati_identifier, 
                          pattern = "XM-DAC-41121-"),
    iati_identifier_year = stringr::str_sub(iati_identifier_year_reg_ops, 
                                                          start = 1, 
                                                          end = 4),
    iati_identifier_reg_ops = stringr::str_sub(iati_identifier_year_reg_ops, 
                                              start = 6),
    iati_identifier_is_notreg = grepl("-", iati_identifier_reg_ops ),
    sep = dplyr::if_else( iati_identifier_is_notreg =="TRUE",
                                       stringr::str_locate( 
                        string = iati_identifier_reg_ops,
                        pattern = "-"),
                        0)[,1]   , 
    iati_identifier_reg  = dplyr::if_else( iati_identifier_is_notreg =="TRUE",
                                           stringr::str_sub(iati_identifier_reg_ops,
                                                          start = 0,
                                                          end = sep-1 ),
                                           iati_identifier_reg_ops  ),
    iati_identifier_reg_lab = dplyr::recode(iati_identifier_reg ,
                         "AFR"  = "Africa"    ,
                         "AME" =  "The Americas" ,
                         "ASO" = "Asia and the Pacific"  ,     
                         "EHGL" = "East and Horn of Africa"    ,
                         "EUR"  = "Europe"   ,  
                         "GLOBALPROG" = "Global Program" ,
                         "HQ"  = "Head Quarter"      , 
                         "JPO"  = "Junior Professional Officer"     ,
                         "MENA" ="Middle East and North Africa"     , 
                         "SA"   = "Southern Africa"     , 
                         "SAO"    = "Southern Africa"   ,  
                         "WCA"    =  "West and Central Africa"  ),
    iati_identifier_ops  = dplyr::if_else(  iati_identifier_is_notreg =="TRUE",
                                            stringr::str_sub(iati_identifier_reg_ops,
                                                             start =   sep + 1 ),
                                           ""),
    ## Extract Country Code
    iati_identifier_ctr  =    stringr::str_sub(iati_identifier_ops ,
                                                start =  0,
                                                end =3),
    ## Detect Operation type
    iati_identifier_ops_type  =     dplyr::if_else(
                                    stringr::str_length(iati_identifier_ops) > 3 ,
                                    stringr::str_sub(iati_identifier_ops ,
                                                     start =  4),
                                    ""),
    ## Get country name & unhcr region
    iati_identifier_ctr_name  =   countrycode::countrycode(iati_identifier_ctr ,
                                                           origin = "iso3c",
                                                           destination = "country.name"),
    iati_identifier_ctr_region  =   countrycode::countrycode(iati_identifier_ctr ,
                                                        origin = "iso3c",
                                                        destination = "unhcr.region") ) |>
  
  dplyr::left_join(iati::codeOrganisationType |> 
                     dplyr::mutate(transorg_type = name) |> 
                     dplyr::select(code, transorg_type) ,
                   by= c("transaction_provider_org_type" = "code")) |> 
  dplyr::left_join(iati::codeTransactionType |> 
                     dplyr::mutate(TransactionType = name,
                                   TransactionDescr = description) |> 
                     dplyr::select(code, TransactionType,TransactionDescr  ) ,
                   by= c("transaction_type_code" = "code")) |> 
  dplyr::left_join(iati::codeAidTypeVocabulary |> 
                     dplyr::mutate(aidvocabulary1 = name,
                                   aidvocabularyDescr1 = description) |> 
                     dplyr::select(code, aidvocabulary1,aidvocabularyDescr1  ) ,
                   by= c("transaction_aid_type_vocabulary_1" = "code")) |> 
  dplyr::left_join(iati::codeAidType |> 
                     dplyr::mutate(AidType1 = name,
                                   AidTypeDescr1 = description) |> 
                     dplyr::select(code, AidType1,AidTypeDescr1  ) ,
                   by= c("transaction_aid_type_code_1" = "code")) |> 
  dplyr::left_join(iati::codeAidTypeVocabulary |> 
                     dplyr::mutate(aidvocabulary2 = name,
                                   aidvocabularyDescr2 = description) |> 
                     dplyr::select(code, aidvocabulary2,aidvocabularyDescr2  ) ,
                   by= c("transaction_aid_type_vocabulary_2" = "code"))|> 
  dplyr::left_join(iati::codeAidType |> 
                     dplyr::mutate(AidType2 = name,
                                   AidTypeDescr2 = description) |> 
                     dplyr::select(code, AidType2,AidTypeDescr2  ) ,
                   by= c("transaction_aid_type_code_2" = "code")) |> 
  dplyr::left_join(iati::dataActivity |> 
                     dplyr::left_join(iati::codeOrganisationType |> 
                                        dplyr::mutate(report_org_type = name) |> 
                                        dplyr::select(code, report_org_type) ,
                                      by= c("reporting_org_type" = "code")) |> 
                     dplyr::left_join(iati::codeActivityScope |> 
                                        dplyr::mutate(codeActivityScope = name) |> 
                                        dplyr::select(code, codeActivityScope) ,
                                      by= c("activity_scope_code" = "code"))  |> 
                     dplyr::left_join(iati::codeCountry |> 
                                        dplyr::mutate(recipientCountry = name) |> 
                                        dplyr::select(code, recipientCountry) ,
                                      by= c("recipient_country_code" = "code")) |> 
                     dplyr::left_join(iati::codeRegion |> 
                                        dplyr::mutate(recipientRegion = name) |> 
                                        dplyr::select(code, recipientRegion) ,
                                      by= c("recipient_region_code" = "code")) |> 
                     dplyr::left_join(iati::codeActivityStatus |> 
                                        dplyr::mutate(ActivityStatus = name) |> 
                                        dplyr::select(code, ActivityStatus) ,
                                      by= c("activity_status_code" = "code")) |> 
                     dplyr::left_join(iati::codeCollaborationType |> 
                                        dplyr::mutate(CollaborationType = name) |> 
                                        dplyr::select(code, CollaborationType) ,
                                      by= c("collaboration_type_code" = "code"))  ,
                   by= c("iati_identifier")) 

Transaction <- Transaction0 |> 
  ## Add filters 
  dplyr::filter(iati_identifier_ctr_region == iati_identifier_ctr_region) |> 
  dplyr::filter(lubridate::year(transaction_date) >= year) |>    
  ## Add filters transaction type  transaction type 
 #  dplyr::filter(TransactionType == "Incoming Commitment") |>  
  dplyr::filter(TransactionType %in% TransactionType) |>  
  dplyr::mutate(
    trans_year = lubridate::year(transaction_date),
    month_trans = factor(format(transaction_date, "%b"), month.abb, ordered = TRUE)
  ) |> 
  dplyr::group_by(trans_year, transorg_type) |>
  dplyr::summarise( transaction_value= sum(transaction_value, na.rm = TRUE)) |>
  dplyr::mutate(transorg_type = as.character(transorg_type) )  |>
  dplyr::mutate(transorg_type = as.factor(transorg_type) ) 

p <- Transaction |> 
#  dplyr::filter(transaction_value <= 1000000 & transaction_value > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value,
             x = trans_year,
             fill = transorg_type)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())
  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr()+
  ggplot2::labs(
    title = paste0(TransactionType," received by UNHCR"),
    subtitle = paste0("In ",  iati_identifier_ctr_region, " recorded since ", year,""),
    x = "",
    y = "",
    caption = "Data Source: UNHCR IATI (International Aid Transparency Initiative)"
  ) 
 
  return(p)
}
```


```{r examples-show_donors, message=FALSE, warning=FALSE}

knitr::kable( codeTransactionType |> dplyr::select(name,  description) )
show_donors(year = 2018,
           iati_identifier_ctr_region = "The Americas",
            TransactionType = "Incoming Commitment" )
```

```{r tests-show_donors}
test_that("show_donors works", {
  expect_true(inherits(show_donors, "function")) 
})
```


# Show implementers 

 
 *  Who are the __main implementing partners by country__ in terms of number of projects and/or total budget?  
 

```{r function-show_implementers, echo=FALSE, message=FALSE, warning=FALSE}
#' Ploting implementer
#'
#' 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_implementers <- function(  ) {
 
}
```
 
```{r examples-show_implementers, message=FALSE, warning=FALSE}
show_implementers( ) 
```

```{r tests-show_implementers}
test_that("show_implementers works", {
  expect_true(inherits(show_implementers, "function")) 
})
```



# show_sectors

 *  What are the __most funded sectors__ per country (Expenditure evolution per impact /outcome area)?  
    
```{r function-show_sectors}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_sectors <- function(){
    
}
```
  
```{r example-show_sectors}
show_sectors()
```
  
```{r tests-show_sectors}
test_that("show_sectors works", {
  expect_true(inherits(show_sectors, "function")) 
})
```
   
 
# show_earmarking

 *  What’s the breakdown of __Earmarking Type__ (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
 
    
```{r function-show_earmarking}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_earmarking <- function(){
    
}
```
  
```{r example-show_earmarking}
show_earmarking()
```
  
```{r tests-show_earmarking}
test_that("show_earmarking works", {
  expect_true(inherits(show_earmarking, "function")) 
})
```
  


# show_partnership

 *  What’s the level of __partnership between organisations__ when implementing projects?  
    
```{r function-show_partnership}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_partnership <- function(){
    
}
```
  
```{r example-show_partnership}
show_partnership()
```
  
```{r tests-show_partnership}
test_that("show_partnership works", {
  expect_true(inherits(show_partnership, "function")) 
})
```
   
  
# show_expenditure

 *  How much __expenditures compare to the initial budget__ (weighted by # PoCs / GPP in the country)?   
    
```{r function-show_expenditure}
#' Title
#' 
#' Description
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_expenditure <- function(){
    
}
```
  
```{r example-show_expenditure}
show_expenditure()
```
  
```{r tests-show_expenditure}
test_that("show_expenditure works", {
  expect_true(inherits(show_expenditure, "function")) 
})
```
  

# show_indicators
    

 *  How much __indicators__ evolve over time against thresholds?
 
```{r function-show_indicators}
#' Title
#' 
#' Description
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_indicators <- function(){
    
}
```
  
```{r example-show_indicators}
show_indicators()
```
  
```{r tests-show_indicators}
test_that("show_indicators works", {
  expect_true(inherits(show_indicators, "function")) 
})
```
  




```{r development-inflate, eval=FALSE}
# Inflate the package

# You're one inflate from paper to box.
# Build your package from this very Rmd using `fusen::inflate()`
# 
# - Verify your `"DESCRIPTION"` file has been updated
# - Verify your function is in `"R/"` directory
# - Verify your test is in `"tests/testthat/"` directory
# - Verify this Rmd appears in `"vignettes/"` directory

# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_unhcr_programme.Rmd", vignette_name = "UNHCR Programme")
```



